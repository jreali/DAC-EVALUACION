<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Facultades y Carreras (barra antes del radar, acoplado a pantalla)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --azul-oscuro:#1c3247;
      --azul-claro:#3c7aa0;
      --naranja:#fc7e00;
    }
    body{
      background: linear-gradient(120deg,var(--azul-oscuro) 70%,var(--azul-claro) 100%);
      font-family: "Segoe UI", Arial, sans-serif;
      color: var(--azul-oscuro);
      margin:0;
    }
    .container{
      max-width:1200px;
      margin:2em auto;
      background:#fff;
      border-radius:16px;
      box-shadow:0 6px 24px rgba(28,50,71,0.13);
      padding:36px 24px 24px 24px;
    }
    h1,h2,h3{ color:var(--azul-oscuro); }
    .global-porcentaje{ display:flex; align-items:center; gap:18px; margin-bottom:16px; }
    .big-badge{
      font-size:2.5em; font-weight:bold; padding:18px 38px; border-radius:16px;
      color:#fff; background:var(--naranja); box-shadow:0 2px 18px rgba(252,126,0,0.11); letter-spacing:0.03em;
    }
    .facultad-table{ margin-bottom:24px; background:#f7fafc; border-radius:10px; overflow-x:auto; box-shadow:0 2px 12px rgba(28,50,71,0.05); }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ padding:9px 7px; border-bottom:1px solid #e3e9f1; text-align:left; font-size:1em; }
    th{ background:var(--azul-claro); color:#fff; font-weight:700; }
    .badge{ padding:3px 10px; border-radius:6px; color:#fff; font-weight:600; background:var(--naranja); }
    select{ background:#fff; border:1.5px solid var(--azul-claro); border-radius:6px; padding:8px 12px; margin-right:12px; font-size:1em; }
    .alerta-baja{ background:#ffe0e0; color:#b03a2e; font-weight:bold; }
    .alerta-media{ background:#fff6e0; color:#f48521; font-weight:bold; }
    .alerta-alta{ background:#e6ffe0; color:#1c7c4c; font-weight:bold; }

    .detalle-section{ margin-bottom:28px; }
    .detalle-combos{ width:100%; margin-bottom:18px; }
    .detalle-combo-row{ display:flex; align-items:center; gap:18px; flex-wrap:wrap; width:100%; }
    .combo-grande{ min-width:350px; max-width:600px; width:100%; font-size:1.1em; padding:8px 12px; border:2px solid var(--azul-claro); border-radius:8px; margin-right:12px; }

    /* Chart layout: acoplado a pantalla (responsive, usa vh para altura) */
    .chart-block{ margin-top:14px; margin-bottom:22px; width:100%; }
    .chart-wrapper{ width:100%; height:35vh; }          /* barra: 35% del alto de la ventana */
    .chart-wrapper-radar{ width:100%; height:38vh; }    /* radar: un poco más alto */
    .chart-wrapper canvas{ width:100% !important; height:100% !important; display:block; }

    @media (max-width:700px){
      .container{ padding:12px 2vw; }
      .big-badge{ font-size:1.5em; padding:10px 18px; }
      table, th, td{ font-size:0.95em; }
      .detalle-combo-row{ flex-direction:column; align-items:flex-start; gap:10px; }
      .combo-grande{ min-width:180px; max-width:100%; }
      .chart-wrapper{ height:42vh; }
      .chart-wrapper-radar{ height:46vh; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Facultades y Carreras</h1>

    <section>
      <div class="global-porcentaje">
        <span><b>Porcentaje Global de las 4 Facultades:</b></span>
        <span id="globalPorcentaje" class="big-badge">--%</span>
      </div>
    </section>

    <section>
      <h2>Resumen General de Facultades</h2>
      <canvas id="chartFacultades" height="80"></canvas>

      <div class="facultad-table">
        <table>
          <thead>
            <tr>
              <th>Facultad</th>
              <th>Total Global</th>
              <th>Carrera Mejor Puntuada</th>
              <th>Carrera Menor Puntuada</th>
            </tr>
          </thead>
          <tbody id="tablaResumenFacultades"></tbody>
        </table>
      </div>

      <!-- Porcentaje global por criterio (mantenido aquí) -->
      <div class="chart-block">
        <h2>Porcentaje Global por Criterio (todas las facultades)</h2>
        <div class="chart-wrapper" style="height:26vh">
          <canvas id="chartGlobalCriterios"></canvas>
        </div>
      </div>
    </section>

    <section class="detalle-section">
      <h2>Detalle por Facultad</h2>
      <label><b>Selecciona facultad:</b></label>
      <select id="facultadSelect"></select>
      <div id="detalleFacultad"></div>
    </section>
  </div>

  <script>
    // Plugins para etiquetas sobre barras / radar (como antes)
    Chart.register({
      id: 'valueLabelsFacultades',
      afterDatasetsDraw(chart){
        const { ctx, chartArea: area } = chart;
        if (!area) return;
        chart.data.datasets.forEach((dataset, i) => {
          chart.getDatasetMeta(i).data.forEach((bar, j) => {
            const value = dataset.data[j];
            ctx.save();
            ctx.font = "bold 13px Segoe UI, Arial";
            ctx.fillStyle = "#fc7e00";
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            if (chart.config.type === "bar") {
              ctx.fillText((value === undefined || Number.isNaN(value)) ? "" : value.toFixed(2) + "%", bar.x, bar.y - 6);
            }
            ctx.restore();
          });
        });
      }
    });

    Chart.register({
      id: 'valueLabelsRadar',
      afterDatasetsDraw(chart){
        const { ctx } = chart;
        if (chart.config.type !== "radar") return;
        chart.data.datasets.forEach((dataset) => {
          chart.getDatasetMeta(0).data.forEach((point, j) => {
            const value = dataset.data[j];
            const angle = chart.scales.r.getIndexAngle(j);
            const radius = chart.scales.r.getDistanceFromCenterForValue(value) + 18;
            const x = chart.scales.r.xCenter + Math.cos(angle - Math.PI/2) * radius;
            const y = chart.scales.r.yCenter + Math.sin(angle - Math.PI/2) * radius;
            ctx.save();
            ctx.font = "bold 13px Segoe UI, Arial";
            ctx.fillStyle = "#fc7e00";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText((value === undefined || Number.isNaN(value)) ? "" : value.toFixed(1) + "%", x, y);
            ctx.restore();
          });
        });
      }
    });

    Chart.register({
      id: 'valueLabelsGlobalCriterios',
      afterDatasetsDraw(chart){
        const { ctx, chartArea: area } = chart;
        if (!area) return;
        chart.data.datasets.forEach((dataset) => {
          chart.getDatasetMeta(0).data.forEach((bar, j) => {
            const value = dataset.data[j];
            ctx.save();
            ctx.font = "bold 13px Segoe UI, Arial";
            ctx.fillStyle = "#fc7e00";
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            if (chart.config.type === "bar") {
              ctx.fillText((value === undefined || Number.isNaN(value)) ? "" : value.toFixed(2) + "%", bar.x, bar.y - 6);
            }
            ctx.restore();
          });
        });
      }
    });

    const criterios_ajustados = [
      "Comunicación institucional",
      "Áreas verdes y recreación",
      "Servicio de cafetería o bares",
      "Prácticas preprofesionales / pasantías",
      "Servicios estudiantiles (biblioteca, bienestar, psicología, becas)",
      "Atención de coordinación/directores",
      "Acceso a recursos tecnológicos",
      "Infraestructura (aulas, laboratorios, talleres)",
      "Calidad de la enseñanza"
    ];

    const datos = [
      { nombre: "Facultad de Ingeniería",
        carreras: [
          { nombre: "Industrial", total:79.0, criterios:[79.8,81.6,76.4,76.2,79.4,77.6,79.0,82.0,79.2] },
          { nombre: "Software", total:79.8, criterios:[79.4,82.8,77.6,78.0,78.0,77.8,81.2,84.4,79.8] },
          { nombre: "Alimentos", total:77.6, criterios:[80.0,86.6,72.4,76.6,82.4,81.6,75.0,81.6,80.8] },
          { nombre: "Ambiental", total:79.6, criterios:[80.6,81.6,78.2,78.6,80.2,78.0,78.0,79.8,81.6] },
          { nombre: "Arquitectura Sostenible", total:79.8, criterios:[80.8,86.6,75.0,81.6,82.4,76.6,72.4,86.6,80.8] },
          { nombre: "Biotecnología", total:71.2, criterios:[72.0,75.4,74.0,69.8,72.6,76.7,71.4,86.6,71.2] },
          { nombre: "TICS", total:82.4, criterios:[83.0,84.0,80.0,82.0,100.0,79.6,83.2,84.2,84.8] }
        ],
        total:78.5
      },
      { nombre: "Facultad de Educación",
        carreras: [
          { nombre:"Educación en Modalidad Presencial", total:80.8, criterios:[79.6,80.0,78.4,81.6,81.6,81.6,81.0,80.4,80.4]},
          { nombre:"Educación Básica en Modalidad en Línea", total:79.4, criterios:[78.4,79.0,77.6,79.6,80.0,80.0,79.6,80.0,80.0]},
          { nombre:"Educación Especial en Modalidad Presencial", total:78.8, criterios:[78.1,78.4,77.0,79.1,80.0,79.5,80.0,80.0,80.0]},
          { nombre:"Educación Inicial en Modalidad Semipresencial", total:80.8, criterios:[81.8,81.8,81.0,80.0,80.4,80.4,80.2,81.2,80.8]},
          { nombre:"Educación Inicial en Modalidad en Línea", total:81.4, criterios:[82.0,82.0,81.0,80.0,80.4,80.4,80.0,81.2,80.8]},
          { nombre:"Pedagogía de la Actividad Física y Deporte en Modalidad Presencial", total:80.8, criterios:[79.2,79.6,79.6,80.0,81.2,81.2,80.8,80.8,80.8]},
          { nombre:"Pedagogía de la Lengua y la Literatura en Modalidad Presencial", total:80.8, criterios:[80.8,81.2,80.8,80.8,81.2,81.2,80.8,80.8,80.8]},
          { nombre:"Pedagogía de las Ciencias Experimentales en Modalidad Semipresencial", total:80.0, criterios:[79.6,80.0,78.8,81.2,80.0,81.4,80.8,80.8,80.8]},
          { nombre:"Pedagogía de los Idiomas Nacionales y Extranjeros en Modalidad en Línea", total:80.4, criterios:[78.4,78.0,77.6,79.4,81.2,80.4,80.8,81.4,81.4]},
          { nombre:"Pedagogía de los Idiomas Nacionales y Extranjeros en Modalidad Presencial", total:81.4, criterios:[80.0,80.4,78.6,81.0,81.4,81.2,80.8,81.4,81.4]}
        ],
        total:80.06
      },
      { nombre: "Facultad de Ciencias Sociales, Educación Comercial y Derecho",
        carreras: [
          { nombre:"Contabilidad y Auditoría en Modalidad", total:78.4, criterios:[79.8,79.2,78.4,78.4,78.6,77.2,77.0,78.4,77.4]},
          { nombre:"Administración de Empresas en Modalidad en Línea", total:80.6, criterios:[79.6,80.0,78.0,80.4,80.0,81.0,81.0,82.0,82.0]},
          { nombre:"Administración de Empresas en Modalidad Presencial", total:79.8, criterios:[79.8,79.4,78.4,79.6,80.0,80.0,80.0,81.0,81.0]},
          { nombre:"Comunicación en Modalidad en Línea", total:78.8, criterios:[78.1,78.4,77.6,80.2,79.0,79.2,79.2,80.0,80.0]},
          { nombre:"Comunicación en Modalidad Presencial", total:80.2, criterios:[79.2,79.6,78.4,80.2,80.6,80.2,80.8,81.2,81.2]},
          { nombre:"Derecho en Modalidad en Línea", total:76.8, criterios:[75.8,76.2,75.8,76.8,77.0,77.2,77.2,80.2,80.2]},
          { nombre:"Economía en Modalidad en Línea", total:79.6, criterios:[78.8,79.2,78.4,79.6,80.0,80.0,80.8,80.8,80.8]},
          { nombre:"Economía en Modalidad Presencial", total:78.8, criterios:[78.8,78.4,77.6,78.8,80.8,79.2,80.0,80.0,80.0]},
          { nombre:"Licenciatura en Psicología en Modalidad", total:80.2, criterios:[79.2,80.2,78.4,80.2,80.2,80.4,79.2,81.2,81.2]},
          { nombre:"Multimedia y Producción Audiovisual", total:79.6, criterios:[78.0,78.4,78.0,79.6,79.6,77.6,80.0,80.4,80.4]},
          { nombre:"Trabajo Social en Modalidad en Línea", total:76.8, criterios:[75.2,75.6,77.2,76.2,79.6,76.4,79.2,77.6,77.6]},
          { nombre:"Trabajo Social en Modalidad Presencial", total:77.8, criterios:[78.8,77.6,77.6,77.8,79.6,76.8,80.0,75.6,77.8]},
          { nombre:"Turismo en Modalidad en Línea", total:77.8, criterios:[76.8,77.2,78.0,78.2,78.2,78.6,78.4,78.2,77.8]},
          { nombre:"Turismo en Modalidad Presencial", total:77.6, criterios:[76.4,76.8,77.4,77.4,80.4,78.2,78.2,77.8,77.6]},
          { nombre:"Psicología en Modalidad en Línea", total:77.6, criterios:[76.8,77.0,76.4,77.6,78.4,77.8,78.8,77.6,77.6]}
        ],
        total:78.59
      },
      { nombre:"Facultad de Ciencias de la Salud",
        carreras:[
          { nombre:"Enfermería", total:81.6, criterios:[81.0,81.2,78.2,82.4,82.2,80.4,81.8,83.8,83.0]},
          { nombre:"Medicina", total:82.3, criterios:[81.2,81.8,79.8,82.4,85.2,78.6,83.8,86.8,81.0]},
          { nombre:"Nutrición y Dietética", total:78.9, criterios:[78.6,78.6,78.5,79.0,80.4,77.2,79.6,81.0,79.6]},
          { nombre:"Fisioterapia", total:80.0, criterios:[80.6,80.6,77.4,80.4,81.2,79.0,80.2,81.4,80.6]}
        ],
        total:80.66
      }
    ];

    function mostrarGlobalPorcentaje(){
      const global = datos.reduce((s,f)=> s + f.total, 0) / datos.length;
      document.getElementById('globalPorcentaje').textContent = global.toFixed(2) + "%";
    }

    function cargarResumenFacultades(){
      const tbody = document.getElementById("tablaResumenFacultades");
      tbody.innerHTML = "";
      datos.forEach(fac => {
        let mejor = fac.carreras[0], peor = fac.carreras[0];
        fac.carreras.forEach(c => { if(c.total > mejor.total) mejor = c; if(c.total < peor.total) peor = c; });
        tbody.innerHTML += `<tr>
          <td><b>${fac.nombre}</b></td>
          <td><span class="badge">${fac.total.toFixed(2)}%</span></td>
          <td>${mejor.nombre} (${mejor.total}%)</td>
          <td>${peor.nombre} (${peor.total}%)</td>
        </tr>`;
      });
    }

    let chartFacultadesInstance;
    function cargarGraficoFacultades(){
      const ctx = document.getElementById('chartFacultades').getContext('2d');
      const etiquetasFacultades = [
        ["Facultad de","Ingeniería"],
        ["Facultad de","Educación"],
        ["Facultad de Ciencias Sociales,","Educación Comercial y Derecho"],
        ["Facultad de Ciencias","de la Salud"]
      ];
      if(chartFacultadesInstance) chartFacultadesInstance.destroy();
      chartFacultadesInstance = new Chart(ctx, {
        type:'bar',
        data:{ labels:etiquetasFacultades, datasets:[{
          label:'Total Global por Facultad',
          data: datos.map(f=>f.total),
          backgroundColor: ['rgba(28,50,71,0.9)','rgba(252,126,0,0.9)','rgba(244,133,33,0.9)','rgba(69,151,191,0.9)'],
          borderRadius:7
        }]},
        options:{
          responsive:true,
          maintainAspectRatio:true,
          plugins:{ legend:{ display:false }, valueLabelsFacultades:true },
          scales:{ x:{ ticks:{ color:"#1c3247", font:{ weight:'bold', size:13}, maxRotation:0, minRotation:0 }, categoryPercentage:0.7, barPercentage:0.9 }, y:{ beginAtZero:true, max:100, ticks:{ color:"#335f7f" } } }
        },
        plugins:['valueLabelsFacultades']
      });
    }

    function cargarSelectorFacultad(){
      const select = document.getElementById('facultadSelect');
      select.innerHTML = "";
      datos.forEach((f,i) => {
        let o = document.createElement("option");
        o.value = i;
        o.text = f.nombre;
        select.appendChild(o);
      });
      select.onchange = cargarDetalleFacultad;
      cargarDetalleFacultad();
    }

    let radarChartInstance;
    let chartDetalleCriterioInstance;

    function cargarDetalleFacultad(){
      const idx = document.getElementById('facultadSelect').value || 0;
      const fac = datos[idx];
      let html = `<h3>${fac.nombre} (${fac.total.toFixed(2)}%)</h3>`;
      const carrerasOrdenadas = [...fac.carreras].sort((a,b)=> a.total - b.total);
      html += `<table><thead><tr><th>Carrera</th><th>Total</th></tr></thead><tbody>`;
      carrerasOrdenadas.forEach(c => {
        let clase = c.total < 77 ? "alerta-baja" : (c.total < 80 ? "alerta-media" : "alerta-alta");
        html += `<tr><td>${c.nombre}</td><td class="${clase}">${c.total}%</td></tr>`;
      });
      html += `</tbody></table>`;

      // Colocamos primero el gráfico de barras (acoplado a pantalla) y luego el radar
      html += `
        <div class="detalle-combos">
          <div class="detalle-combo-row">
            <label for="carreraSelect" style="font-weight:600; margin-right:8px;">Ver detalle:</label>
            <select id="carreraSelect" class="combo-grande"></select>
          </div>
        </div>

        <div class="chart-block">
          <h3>Porcentaje por criterio (carrera seleccionada)</h3>
          <div class="chart-wrapper"><canvas id="chartDetalleCriterio"></canvas></div>
        </div>

        <div class="chart-block">
          <h3>Radar (carrera seleccionada)</h3>
          <div class="chart-wrapper-radar"><canvas id="chartRadar"></canvas></div>
        </div>
      `;

      document.getElementById("detalleFacultad").innerHTML = html;

      const selCarrera = document.getElementById('carreraSelect');
      fac.carreras.forEach((c,i)=>{
        let o = document.createElement("option");
        o.value = i;
        o.text = c.nombre;
        selCarrera.appendChild(o);
      });

      selCarrera.onchange = function(){
        cargarGraficoDetalleCriterio(fac);
        cargarGraficoRadar(fac);
      };

      // dibujar inicial
      cargarGraficoDetalleCriterio(fac);
      cargarGraficoRadar(fac);
    }

    function cargarGraficoDetalleCriterio(fac){
      const idx = parseInt(document.getElementById('carreraSelect').value || 0, 10);
      const carrera = fac.carreras[idx];
      const ctx = document.getElementById('chartDetalleCriterio').getContext('2d');

      const labels = criterios_ajustados.slice(0, carrera.criterios.length);
      const valores = carrera.criterios;

      if(chartDetalleCriterioInstance) chartDetalleCriterioInstance.destroy();

      chartDetalleCriterioInstance = new Chart(ctx, {
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'',
            data:valores,
            backgroundColor:'rgba(252,126,0,0.85)',
            borderColor:'#fc7e00',
            borderRadius:6
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false, // permite que la canvas ocupe la altura definida por CSS (vh)
          plugins:{ legend:{ display:false }, valueLabelsFacultades:true },
          scales:{
            x:{ ticks:{ color:"#1c3247", font:{ weight:'bold', size:12 }, maxRotation:30, minRotation:30 } },
            y:{ beginAtZero:true, max:100, ticks:{ color:"#335f7f" } }
          }
        },
        plugins:['valueLabelsFacultades']
      });
    }

    function cargarGraficoRadar(fac){
      const idx = parseInt(document.getElementById('carreraSelect').value || 0, 10);
      const carrera = fac.carreras[idx];
      const ctx = document.getElementById('chartRadar').getContext('2d');
      if(radarChartInstance) radarChartInstance.destroy();

      radarChartInstance = new Chart(ctx, {
        type:'radar',
        data:{
          labels: criterios_ajustados.slice(0, carrera.criterios.length),
          datasets:[{
            label: carrera.nombre,
            data: carrera.criterios,
            backgroundColor:"rgba(63,122,160,0.18)",
            borderColor:"#fc7e00",
            pointBackgroundColor:"#fc7e00"
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ valueLabelsRadar:true, legend:{ display:false } },
          scales:{ r:{ angleLines:{ color:"#335f7f" }, suggestedMin:60, suggestedMax:100, pointLabels:{ color:"#1c3247", font:{ size:13, weight:'bold' } } } }
        },
        plugins:['valueLabelsRadar']
      });
    }

    let chartGlobalCriteriosInstance;
    function cargarGraficoGlobalCriterios(){
      const criteriosCount = criterios_ajustados.length;
      const sumas = Array(criteriosCount).fill(0);
      let totalCarreras = 0;
      datos.forEach(fac => fac.carreras.forEach(carrera => {
        carrera.criterios.forEach((valor,i)=> sumas[i]+=valor);
        totalCarreras++;
      }));
      const promedios = sumas.map(s => s / totalCarreras);

      const ctx = document.getElementById('chartGlobalCriterios').getContext('2d');
      if(chartGlobalCriteriosInstance) chartGlobalCriteriosInstance.destroy();
      chartGlobalCriteriosInstance = new Chart(ctx, {
        type:'bar',
        data:{ labels: criterios_ajustados, datasets:[{
          label:'Porcentaje Global por Criterio',
          data: promedios,
          backgroundColor:'rgba(252,126,0,0.7)',
          borderColor:'#fc7e00',
          borderRadius:6
        }]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false }, valueLabelsGlobalCriterios:true },
          scales:{ x:{ ticks:{ color:"#1c3247", font:{ weight:'bold', size:13 } } }, y:{ beginAtZero:true, max:100, ticks:{ color:"#335f7f" } } }
        },
        plugins:['valueLabelsGlobalCriterios']
      });
    }

    // Inicialización
    mostrarGlobalPorcentaje();
    cargarResumenFacultades();
    cargarGraficoFacultades();
    cargarSelectorFacultad();
    cargarGraficoGlobalCriterios();
  </script>
</body>
</html>
